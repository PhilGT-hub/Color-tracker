<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Object Tracker No Rectangle Required</title>
<style>
body { font-family: sans-serif; text-align: center; background: #f0f0f0; padding: 20px; }
video, canvas { border: 1px solid #333; margin-top: 10px; touch-action: none; }
#controls { margin: 10px; }
button { margin: 0 5px; padding: 8px 12px; }
</style>
</head>
<body>
<h1>Object Tracker (No Rectangle Needed)</h1>
<div id="controls">
  <button id="screenshotBtn">Screen Shot</button>
  <button id="applyBtn">Apply Tracking</button>
  <button id="flipBtn">Flip Camera</button>
</div>

<video id="video" autoplay playsinline muted width="320" height="240"></video>
<canvas id="canvas" width="320" height="240"></canvas>
<canvas id="screenshotCanvas" width="320" height="240" style="display:none"></canvas>

<script>
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const screenshotCanvas = document.getElementById('screenshotCanvas');
const scCtx = screenshotCanvas.getContext('2d');

let template = null;
let templateRect = null;
let isSelecting = false;
let startX=0, startY=0;
let stream = null;
let currentFacingMode = "environment";

// --- CAMERA ---
async function startCamera(facingMode){
    if(stream) stream.getTracks().forEach(t=>t.stop());
    try{
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode } });
        video.srcObject = stream;
    } catch(e){
        console.log("Camera access failed, using default: ", e);
        stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
    }
}
startCamera(currentFacingMode);

// --- SCREENSHOT ---
document.getElementById('screenshotBtn').addEventListener('click', ()=>{
    scCtx.drawImage(video,0,0,canvas.width,canvas.height);
    ctx.drawImage(video,0,0,canvas.width,canvas.height);
    template = null;
    templateRect = null;
});

// --- FLIP CAMERA ---
document.getElementById('flipBtn').addEventListener('click', ()=>{
    currentFacingMode = currentFacingMode==="environment"?"user":"environment";
    startCamera(currentFacingMode);
});

// --- DRAW RECTANGLE ---
function getPos(e){
    const rect = canvas.getBoundingClientRect();
    let clientX = e.clientX, clientY = e.clientY;
    if(e.touches){ clientX = e.touches[0].clientX; clientY = e.touches[0].clientY; }
    return {x: clientX - rect.left, y: clientY - rect.top};
}

canvas.addEventListener('mousedown', startDraw);
canvas.addEventListener('touchstart', startDraw);
canvas.addEventListener('mousemove', drawRect);
canvas.addEventListener('touchmove', drawRect);
canvas.addEventListener('mouseup', endDraw);
canvas.addEventListener('touchend', endDraw);

function startDraw(e){
    if(!scCtx) return;
    isSelecting = true;
    const pos = getPos(e);
    startX = pos.x; startY = pos.y;
}

function drawRect(e){
    if(!isSelecting) return;
    const pos = getPos(e);
    const w = pos.x - startX;
    const h = pos.y - startY;
    ctx.drawImage(screenshotCanvas,0,0,canvas.width,canvas.height);
    ctx.strokeStyle = 'red';
    ctx.lineWidth = 2;
    ctx.strokeRect(startX,startY,w,h);
    e.preventDefault();
}

function endDraw(e){
    if(!isSelecting) return;
    const pos = getPos(e);
    templateRect = {
        x: Math.min(startX,pos.x),
        y: Math.min(startY,pos.y),
        w: Math.abs(pos.x-startX),
        h: Math.abs(pos.y-startY)
    };
    // Extract template from screenshotCanvas
    const tmpCanvas = document.createElement('canvas');
    const tmpCtx = tmpCanvas.getContext('2d');
    const maxSize = 50;
    tmpCanvas.width = maxSize;
    tmpCanvas.height = maxSize;

    tmpCtx.drawImage(
        screenshotCanvas,
        templateRect.x, templateRect.y, templateRect.w, templateRect.h,
        0,0,maxSize,maxSize
    );
    template = tmpCtx.getImageData(0,0,maxSize,maxSize);
    isSelecting = false;
}

// --- TEMPLATE MATCHING ---
function applyTracking(){
    // If no template exists, just use the full screenshot as template
    if(!template){
        const tmpCanvas = document.createElement('canvas');
        const tmpCtx = tmpCanvas.getContext('2d');
        const maxSize = 50;
        tmpCanvas.width = maxSize;
        tmpCanvas.height = maxSize;
        tmpCtx.drawImage(screenshotCanvas, 0, 0, screenshotCanvas.width, screenshotCanvas.height,
            0,0,maxSize,maxSize);
        template = tmpCtx.getImageData(0,0,maxSize,maxSize);
        templateRect = { x:0, y:0, w:canvas.width, h:canvas.height }; // for scaling
    }

    const t = template;

    function matchFrame(){
        ctx.drawImage(video,0,0,canvas.width,canvas.height);
        const frame = ctx.getImageData(0,0,canvas.width,canvas.height);

        let bestDiff = Infinity;
        let bestX=0, bestY=0;
        const step = 4;

        for(let y=0; y<=frame.height-t.height; y+=step){
            for(let x=0; x<=frame.width-t.width; x+=step){
                let diff=0;
                for(let ty=0; ty<t.height; ty+=2){
                    for(let tx=0; tx<t.width; tx+=2){
                        const fi = ((y+ty)*frame.width + (x+tx))*4;
                        const ti = (ty*t.width + tx)*4;
                        diff += Math.abs(frame.data[fi]-t.data[ti]);
                        diff += Math.abs(frame.data[fi+1]-t.data[ti+1]);
                        diff += Math.abs(frame.data[fi+2]-t.data[ti+2]);
                    }
                }
                if(diff<bestDiff){ bestDiff=diff; bestX=x; bestY=y; }
            }
        }

        const scaleX = templateRect.w / t.width;
        const scaleY = templateRect.h / t.height;
        ctx.strokeStyle = 'lime';
        ctx.lineWidth = 2;
        ctx.strokeRect(bestX,bestY,t.width*scaleX, t.height*scaleY);

        requestAnimationFrame(matchFrame);
    }
    matchFrame();
}

document.getElementById('applyBtn').addEventListener('click', applyTracking);
</script>
</body>
</html>
